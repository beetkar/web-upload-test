<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ESP Live Sensor Dashboard</title>
  <style>
    :root { --pad:16px; }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:var(--pad);background:#f7f7fb}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    h2{margin:0 0 6px 0;font-weight:700}
    #status{font-size:14px;opacity:.7}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .card{background:#fff;border-radius:14px;padding:14px;box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .card h3{margin:0 0 8px 0;font-size:16px}
    canvas{width:100%;height:300px}
    .table-wrap{max-height:360px;overflow:auto}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:8px 10px;border-bottom:1px solid #eee;text-align:left}
    th{background:#fafafa;position:sticky;top:0;z-index:1}
    footer{margin-top:14px;color:#666;font-size:12px}
    code{background:#f0f0f4;padding:2px 6px;border-radius:6px}
    @media(max-width:900px){.grid{grid-template-columns:1fr} canvas{height:240px}}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <div>
      <h2>ESP Live Sensor Dashboard</h2>
      <div id="status">Connecting…</div>
    </div>
  </header>

  <div class="card" style="margin-bottom:12px">
    <strong>Config</strong>
    <div style="font-size:13px;color:#555;margin-top:6px">
      Set your Supabase values below (or define them inline in code).
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
      <input id="url" placeholder="SUPABASE_URL" style="flex:1;padding:8px;border:1px solid #ddd;border-radius:8px">
      <input id="anon" placeholder="SUPABASE_ANON_KEY" style="flex:2;padding:8px;border:1px solid #ddd;border-radius:8px">
      <button id="save" style="padding:8px 12px;border:0;border-radius:8px;background:#111;color:#fff">Save</button>
    </div>
    <div style="font-size:12px;color:#777;margin-top:6px">
      Tip: after saving once, values persist in <code>localStorage</code>.
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h3>Temperature (°C)</h3>
      <canvas id="tempChart"></canvas>
    </div>
    <div class="card">
      <h3>Humidity (%)</h3>
      <canvas id="humChart"></canvas>
    </div>
    <div class="card" style="grid-column:1/-1">
      <h3>Recent Data</h3>
      <div class="table-wrap">
        <table id="dataTable">
          <thead>
            <tr><th>Time</th><th>Device</th><th>Temp (°C)</th><th>Humidity (%)</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <footer>
    ESP posts to <code>/.netlify/functions/ingest</code> with header <code>x-api-key</code>.<br>
    This page reads directly from Supabase (history + realtime).
  </footer>

  <script>
    // ---- Config: fetch from localStorage or URL query once, then persist ----
    const qs = new URLSearchParams(location.search);
    const LS_URL = localStorage.getItem('SUPABASE_URL');
    const LS_ANON = localStorage.getItem('SUPABASE_ANON_KEY');
    const SUPABASE_URL = qs.get('url') || LS_URL || 'https://xdfxyokrkvlslfevwelx.supabase.co';
    const SUPABASE_ANON_KEY = qs.get('anon') || LS_ANON || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhkZnh5b2tya3Zsc2xmZXZ3ZWx4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MDMyNDIsImV4cCI6MjA3NDM3OTI0Mn0.i54gUByR54eED2SBnOWIZaXWmYyl37VVgzCR-TBrA50';

    document.getElementById('url').value = SUPABASE_URL;
    document.getElementById('anon').value = SUPABASE_ANON_KEY;
    document.getElementById('save').onclick = () => {
      localStorage.setItem('SUPABASE_URL', document.getElementById('url').value);
      localStorage.setItem('SUPABASE_ANON_KEY', document.getElementById('anon').value);
      location.reload();
    };

    const supabase = supabaseLib.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const maxPoints = 240; const labels = []; const tData = []; const hData = [];
    const tempChart = new Chart(document.getElementById('tempChart').getContext('2d'), {
      type:'line', data:{labels,datasets:[{label:'Temperature',data:tData,tension:.25,pointRadius:0}]},
      options:{animation:false,responsive:true,scales:{y:{beginAtZero:false}}}
    });
    const humChart = new Chart(document.getElementById('humChart').getContext('2d'), {
      type:'line', data:{labels,datasets:[{label:'Humidity',data:hData,tension:.25,pointRadius:0}]},
      options:{animation:false,responsive:true,scales:{y:{beginAtZero:true,suggestedMax:100}}}
    });

    const tbody = document.querySelector('#dataTable tbody');
    function addRow(r){
      const tr = document.createElement('tr');
      const t = new Date(r.received_at || r.ts_ms || Date.now()).toLocaleTimeString();
      tr.innerHTML = `<td>${t}</td><td>${r.device_id||''}</td><td>${Number(r.temperature).toFixed(2)}</td><td>${Number(r.humidity||0).toFixed(2)}</td>`;
      tbody.prepend(tr); while (tbody.rows.length>200) tbody.deleteRow(-1);
    }
    function pushPoint(ts,t,h){
      labels.push(new Date(ts).toLocaleTimeString());
      tData.push(Number(t)); hData.push(Number(h));
      if(labels.length>maxPoints){labels.shift(); tData.shift(); hData.shift();}
      tempChart.update(); humChart.update();
    }

    async function loadInitial(){
      const { data, error } = await supabase
        .from('readings')
        .select('*')
        .order('id', { ascending: false })
        .limit(200);
      if (error) { console.warn(error); return; }
      data.reverse().forEach(r => { pushPoint(r.received_at||r.ts_ms,r.temperature,r.humidity); addRow(r); });
    }
    function subscribeRealtime(){
      const channel = supabase.channel('readings-inserts')
        .on('postgres_changes', {event:'INSERT',schema:'public',table:'readings'}, (payload)=>{
          const r = payload.new; pushPoint(r.received_at||r.ts_ms,r.temperature,r.humidity); addRow(r);
        }).subscribe();
      document.getElementById('status').textContent = 'Live (Supabase Realtime)';
    }
    loadInitial(); subscribeRealtime();
  </script>
</body>
</html>
